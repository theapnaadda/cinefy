<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CINEFY - Stream Universe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#000000',
                        surface: '#0a0a0a',
                        glass: 'rgba(20, 20, 20, 0.6)',
                        gold: '#FFD700',
                        neonRed: '#FF003C',
                        neonBlue: '#00F0FF',
                        neonGreen: '#00FF41'
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow-gold': '0 0 15px rgba(255, 215, 0, 0.3)',
                        'glow-red': '0 0 20px rgba(255, 0, 60, 0.4)',
                        'glow-blue': '0 0 20px rgba(0, 240, 255, 0.4)',
                        'glow-green': '0 0 20px rgba(0, 255, 65, 0.4)',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #000000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #FFD700; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .glass-panel { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-heavy { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(30px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* SLIDER STYLES */
        .slider-container { width: 100%; height: 100%; overflow: hidden; position: relative; }
        .slider-track { display: flex; height: 100%; width: 100%; }
        .slide { min-width: 100%; height: 100%; flex-shrink: 0; position: relative; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }

        .input-glow:focus { box-shadow: 0 0 15px rgba(0, 240, 255, 0.2); border-color: #00F0FF; }
        
        .toast-enter { transform: translateY(-20px) scale(0.95); opacity: 0; }
        .toast-enter-active { transform: translateY(0) scale(1); opacity: 1; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-exit-active { transform: translateY(-20px) scale(0.9); opacity: 0; transition: all 0.3s ease; }

        /* Custom Hover for Category Cards */
        .cat-card:hover .cat-icon { transform: scale(1.2) rotate(10deg); opacity: 0.2; }
        .cat-card:hover .cat-bg { transform: scale(1.05); }
    </style>
</head>
<body class="bg-dark text-gray-100 antialiased overflow-x-hidden min-h-screen flex flex-col selection:bg-neonBlue selection:text-black">

    <!-- ================= CLIENT APP VIEW ================= -->
    <div id="client-view" class="w-full min-h-screen flex flex-col md:flex-row relative bg-dark">
        
        <!-- SIDEBAR (DESKTOP) -->
        <aside class="hidden md:flex flex-col w-64 h-screen fixed left-0 top-0 glass-heavy z-50 border-r border-white/5 shadow-glow-blue">
            <div class="p-8 pb-4">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-neonBlue to-purple-600 tracking-tighter cursor-pointer drop-shadow-lg" onclick="navClient('home')">CINEFY</h1>
            </div>
            <nav class="flex-1 px-4 space-y-3 py-4">
                <button onclick="navClient('home')" class="nav-sidebar-btn w-full flex items-center space-x-4 px-4 py-3.5 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group border border-transparent hover:border-white/10" data-target="home">
                    <i class="fa-solid fa-house text-lg group-hover:text-neonBlue transition"></i><span class="font-medium">Home</span>
                </button>
                <button onclick="navClient('search')" class="nav-sidebar-btn w-full flex items-center space-x-4 px-4 py-3.5 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group border border-transparent hover:border-white/10" data-target="search">
                    <i class="fa-solid fa-magnifying-glass text-lg group-hover:text-neonBlue transition"></i><span class="font-medium">Search</span>
                </button>
                <button onclick="navClient('categories')" class="nav-sidebar-btn w-full flex items-center space-x-4 px-4 py-3.5 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group border border-transparent hover:border-white/10" data-target="categories">
                    <i class="fa-solid fa-layer-group text-lg group-hover:text-neonBlue transition"></i><span class="font-medium">Browse</span>
                </button>
                <button onclick="navClient('profile')" class="nav-sidebar-btn w-full flex items-center space-x-4 px-4 py-3.5 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition group border border-transparent hover:border-white/10" data-target="profile">
                    <i class="fa-solid fa-user text-lg group-hover:text-neonBlue transition"></i><span class="font-medium">Profile</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 w-full md:ml-64 flex flex-col min-h-screen relative">

            <!-- Mobile Header -->
            <header class="md:hidden fixed top-0 left-0 right-0 h-16 glass-heavy z-40 px-5 flex justify-between items-center shadow-lg shadow-blue-900/10">
                <h1 class="text-2xl font-black text-neonBlue tracking-tighter cursor-pointer drop-shadow-[0_0_10px_rgba(0,240,255,0.5)]" onclick="navClient('home')">CINEFY</h1>
                
                <div class="flex items-center space-x-3">
                    <button id="header-login-mobile" onclick="navClient('profile')" class="hidden bg-gradient-to-r from-neonRed to-red-600 text-white text-[10px] font-bold px-4 py-1.5 rounded-full shadow-glow-red animate-pulse">
                        LOGIN
                    </button>
                    
                    <button id="nav-admin-btn-mobile" onclick="openAdminPanel()" class="hidden text-[10px] uppercase tracking-wider bg-gold/10 border border-gold text-gold px-3 py-1.5 rounded-full font-bold shadow-glow-gold">
                        Admin
                    </button>
                    
                    <div id="notif-wrapper-mobile" class="relative z-50">
                        <button onclick="toggleNotifications()" class="w-9 h-9 rounded-full bg-white/5 flex items-center justify-center border border-white/10 hover:border-neonBlue transition active:scale-95">
                            <i class="fa-solid fa-bell text-gray-400 text-sm"></i>
                            <div id="notif-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-neonRed rounded-full border-2 border-dark shadow-glow-red"></div>
                        </button>
                        <div id="notif-dropdown" class="absolute top-12 right-0 w-72 bg-[#050505] border border-gray-800 rounded-xl shadow-2xl hidden flex flex-col origin-top-right transition-all duration-200 z-[60]">
                            <div class="p-3 border-b border-gray-800 flex justify-between items-center">
                                <h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">New Releases</h3>
                                <button onclick="toggleNotifications()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div id="notif-list" class="max-h-64 overflow-y-auto custom-scrollbar p-2 space-y-2"></div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Desktop Header Tools -->
            <div class="hidden md:flex absolute top-5 right-8 z-50 items-center space-x-4">
                <button id="header-login-desk" onclick="navClient('profile')" class="hidden bg-gradient-to-r from-neonRed to-red-600 hover:from-red-500 hover:to-red-600 text-white text-xs font-bold px-6 py-2.5 rounded-full shadow-glow-red transition transform hover:scale-105">
                    LOGIN TO WATCH
                </button>

                <button id="nav-admin-btn-desktop" onclick="openAdminPanel()" class="hidden text-xs uppercase tracking-wider bg-gold/10 border border-gold text-gold px-4 py-2 rounded-full font-bold hover:bg-gold hover:text-black transition shadow-glow-gold">
                    Admin Panel
                </button>
                <div id="notif-wrapper-desk" class="relative">
                     <button onclick="toggleNotifications()" class="w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center border border-white/10 hover:border-neonBlue hover:shadow-glow-blue transition">
                        <i class="fa-solid fa-bell text-gray-300"></i>
                        <div id="notif-badge-desk" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-neonRed rounded-full border border-dark shadow-glow-red"></div>
                    </button>
                     <div id="notif-dropdown-desk" class="absolute top-14 right-0 w-80 bg-[#050505] border border-gray-800 rounded-xl shadow-2xl hidden flex flex-col z-[60]">
                        <div class="p-4 border-b border-gray-800"><h3 class="text-sm font-bold text-white">Notifications</h3></div>
                        <div id="notif-list-desk" class="max-h-80 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Main Scroll Area -->
            <main id="client-content" class="flex-1 w-full pt-16 md:pt-0 pb-24 md:pb-0 overflow-y-auto scroll-smooth bg-dark">
                
                <!-- HOME VIEW -->
                <div id="view-home" class="client-subview w-full fade-in">
                    <!-- Banner Slider -->
                    <!-- UPDATED: Added aspect-video for mobile to see full banner, md:h-[75vh] for desktop -->
                    <div class="relative w-full aspect-video md:aspect-auto md:h-[75vh] bg-gray-900 group">
                        <div class="slider-container">
                            <div id="banner-track" class="slider-track">
                                <div class="w-full h-full flex items-center justify-center"><div class="loader"></div></div>
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/40 to-transparent pointer-events-none"></div>
                        
                        <!-- Slider Controls (Arrows) - Optional but good for desktop -->
                        <button onclick="moveSlide(-1, Object.keys(bannersData).length)" class="hidden md:flex absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 items-center justify-center rounded-full bg-black/30 hover:bg-black/60 text-white z-20 backdrop-blur-sm transition">
                             <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <button onclick="moveSlide(1, Object.keys(bannersData).length)" class="hidden md:flex absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 items-center justify-center rounded-full bg-black/30 hover:bg-black/60 text-white z-20 backdrop-blur-sm transition">
                             <i class="fa-solid fa-chevron-right"></i>
                        </button>

                        <div id="slider-indicators" class="absolute bottom-6 left-0 right-0 flex justify-center space-x-2 z-20"></div>
                    </div>

                    <!-- Movies Rows -->
                    <!-- UPDATED: Adjusted margin top to pull movies up slightly -->
                    <div id="movies-container" class="pb-10 pt-4 space-y-10 min-h-[200px] relative z-10 -mt-8 md:-mt-32"></div>
                </div>

                <!-- SEARCH VIEW -->
                <div id="view-search" class="client-subview hidden w-full px-5 md:px-10 pt-6 md:pt-10 fade-in min-h-[80vh]">
                    <h2 class="text-3xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-neonBlue to-white">Search Library</h2>
                    <div class="relative mb-8 max-w-2xl">
                        <i class="fa-solid fa-search absolute left-5 top-4 text-gray-400"></i>
                        <input type="text" id="search-input" onkeyup="performSearch()" placeholder="Find movies, TV shows..." class="input-glow w-full bg-white/5 border border-white/10 pl-14 pr-4 py-4 rounded-2xl text-white focus:outline-none focus:bg-white/10 transition text-lg">
                    </div>
                    <div id="search-results" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-x-4 md:gap-x-6 gap-y-8 pb-10"></div>
                </div>

                <!-- CATEGORIES VIEW -->
                <div id="view-categories" class="client-subview hidden w-full px-5 md:px-10 pt-6 md:pt-10 fade-in min-h-[80vh]">
                    <div id="categories-main-list" class="fade-in">
                        <div class="flex items-center space-x-3 mb-8">
                            <h2 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-neonGreen to-white tracking-tight">Browse by Genre</h2>
                            <div class="h-1 flex-1 bg-gradient-to-r from-neonGreen/50 to-transparent rounded-full opacity-50"></div>
                        </div>
                        <!-- Updated Grid with Better Gap -->
                        <div id="categories-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-12"></div>
                    </div>

                    <div id="category-movies-view" class="hidden fade-in">
                        <div class="flex items-center mb-8 space-x-4">
                            <button onclick="backToCategories()" class="w-12 h-12 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white hover:border-neonBlue hover:shadow-glow-blue transition active:scale-95 group">
                                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i>
                            </button>
                            <h2 id="selected-category-title" class="text-3xl font-bold text-neonBlue truncate">Category</h2>
                        </div>
                        <div id="selected-category-results" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-8 pb-20"></div>
                    </div>
                </div>

                <!-- PROFILE VIEW -->
                <div id="view-profile" class="client-subview hidden w-full px-5 md:px-0 pt-10 flex flex-col items-center fade-in">
                    <!-- Content injected by JS -->
                </div>

                <!-- HISTORY VIEW -->
                <div id="view-history" class="client-subview hidden w-full px-5 md:px-10 pt-6 md:pt-10 fade-in min-h-[80vh]">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center space-x-4">
                            <button onclick="navClient('profile')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center border border-white/10 hover:border-neonBlue transition"><i class="fa-solid fa-arrow-left"></i></button>
                            <h2 class="text-2xl font-bold text-neonBlue">Watch History</h2>
                        </div>
                        <button onclick="clearAllHistory()" class="text-xs text-neonRed font-medium border border-neonRed/30 px-4 py-2 rounded-lg hover:bg-neonRed/10 hover:shadow-glow-red transition">Clear All</button>
                    </div>
                    <div id="history-list" class="space-y-4 pb-20 max-w-4xl mx-auto"></div>
                </div>
            </main>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 h-20 glass-heavy border-t border-white/5 flex justify-around items-center z-40 pb-2 shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <button onclick="navClient('home')" class="nav-btn text-neonBlue flex flex-col items-center w-full h-full justify-center active:scale-90 transition duration-200" data-target="home">
                <i class="fa-solid fa-house text-xl mb-1.5 drop-shadow-md"></i><span class="text-[10px] font-medium tracking-wide">Home</span>
            </button>
            <button onclick="navClient('search')" class="nav-btn text-gray-500 flex flex-col items-center w-full h-full justify-center active:scale-90 transition duration-200" data-target="search">
                <i class="fa-solid fa-magnifying-glass text-xl mb-1.5"></i><span class="text-[10px] font-medium tracking-wide">Search</span>
            </button>
            <button onclick="navClient('categories')" class="nav-btn text-gray-500 flex flex-col items-center w-full h-full justify-center active:scale-90 transition duration-200" data-target="categories">
                <i class="fa-solid fa-layer-group text-xl mb-1.5"></i><span class="text-[10px] font-medium tracking-wide">Browse</span>
            </button>
            <button onclick="navClient('profile')" class="nav-btn text-gray-500 flex flex-col items-center w-full h-full justify-center active:scale-90 transition duration-200" data-target="profile">
                <i class="fa-solid fa-user text-xl mb-1.5"></i><span class="text-[10px] font-medium tracking-wide">Profile</span>
            </button>
        </nav>

        <!-- Movie Detail Overlay -->
        <div id="movie-modal" class="fixed inset-0 z-[150] hidden bg-black/95 overflow-y-auto animate-in fade-in duration-300 backdrop-blur-3xl">
            <div class="relative w-full min-h-screen pb-10 flex flex-col md:flex-row">
                <button onclick="closeModal()" class="fixed top-6 left-6 z-[160] w-12 h-12 bg-black/60 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white/20 transition border border-white/10 group">
                    <i class="fa-solid fa-xmark text-xl group-hover:rotate-90 transition duration-300"></i>
                </button>
                <div class="w-full md:w-1/2 relative h-[60vh] md:h-screen">
                    <img id="modal-poster" src="" class="w-full h-full object-cover md:object-center shadow-glow-blue">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent md:bg-gradient-to-r md:from-transparent md:to-black"></div>
                </div>
                <div class="w-full md:w-1/2 px-6 md:px-12 -mt-24 md:mt-0 relative z-10 flex flex-col justify-center">
                    <h1 id="modal-title" class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-400 mb-4 leading-tight drop-shadow-lg"></h1>
                    <div class="flex items-center space-x-4 text-sm text-gray-300 mb-8">
                        <span id="modal-year" class="bg-white/10 border border-white/10 px-3 py-1 rounded-lg text-sm font-semibold text-gray-200"></span>
                        <span id="modal-rating" class="text-gold font-bold flex items-center bg-gold/10 px-3 py-1 rounded-lg border border-gold/20 shadow-glow-gold"><i class="fa-solid fa-star text-xs mr-2"></i> <span></span></span>
                    </div>
                    
                    <button id="modal-watch-btn" class="flex items-center justify-center w-full md:w-max bg-gradient-to-r from-blue-600 to-neonBlue text-black px-10 py-4 rounded-xl font-bold text-lg mb-10 shadow-glow-blue transition transform active:scale-95 hover:brightness-110">
                        <i class="fa-solid fa-play mr-3"></i> Watch Now
                    </button>
                    
                    <div class="space-y-8 max-w-xl">
                        <div>
                            <h3 class="font-bold text-neonBlue mb-2 uppercase text-xs tracking-widest">Synopsis</h3>
                            <p id="modal-desc" class="text-gray-300 leading-relaxed text-base font-light opacity-90"></p>
                        </div>
                        <div>
                            <h3 class="font-bold text-neonBlue mb-2 uppercase text-xs tracking-widest">Cast</h3>
                            <p id="modal-cast" class="text-gray-400 text-sm font-light"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Video Player Overlay (Full Screen) -->
        <div id="video-player-overlay" class="fixed inset-0 z-[200] hidden bg-black flex flex-col">
            <div class="flex justify-between items-center p-4 bg-black/80 backdrop-blur absolute top-0 left-0 right-0 z-10">
                <h3 class="text-white font-bold text-lg truncate pr-4">Now Playing</h3>
                <button onclick="closeVideo()" class="text-white hover:text-neonRed text-xl px-4 py-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="player-container" class="flex-1 w-full h-full flex items-center justify-center bg-black">
                <!-- Iframe injected here -->
            </div>
        </div>
    </div>

    <!-- ================= ADMIN PANEL VIEW ================= -->
    <div id="admin-view" class="hidden fixed inset-0 z-50 flex flex-col md:flex-row bg-[#020617] fade-in">
        <aside class="fixed bottom-0 w-full h-16 md:relative md:h-full md:w-64 bg-[#050505] border-t md:border-t-0 md:border-r border-gray-800 flex flex-row md:flex-col shrink-0 z-50 order-2 md:order-1 shadow-glow-gold">
            <div class="hidden md:flex p-6 justify-between items-center border-b border-gray-800">
                <h1 class="text-xl font-bold text-gold tracking-wider">ADMIN<span class="text-white">PANEL</span></h1>
            </div>
            <nav class="flex-1 w-full flex md:flex-col justify-around md:justify-start md:p-4 md:space-y-2">
                <button onclick="navAdmin('dashboard')" class="admin-nav-btn flex-1 md:flex-none flex flex-col md:flex-row items-center md:space-x-3 justify-center md:justify-start px-2 py-2 md:px-4 md:py-3 rounded-xl text-gray-400 hover:text-gold hover:bg-gold/10 transition group" data-target="dashboard">
                    <i class="fa-solid fa-chart-simple text-lg md:text-base mb-1 md:mb-0"></i> <span class="text-[10px] md:text-sm font-medium">Dashboard</span>
                </button>
                <button onclick="navAdmin('movies')" class="admin-nav-btn flex-1 md:flex-none flex flex-col md:flex-row items-center md:space-x-3 justify-center md:justify-start px-2 py-2 md:px-4 md:py-3 rounded-xl text-gray-400 hover:text-gold hover:bg-gold/10 transition group" data-target="movies">
                    <i class="fa-solid fa-film text-lg md:text-base mb-1 md:mb-0"></i> <span class="text-[10px] md:text-sm font-medium">Movies</span>
                </button>
                <button onclick="navAdmin('categories')" class="admin-nav-btn flex-1 md:flex-none flex flex-col md:flex-row items-center md:space-x-3 justify-center md:justify-start px-2 py-2 md:px-4 md:py-3 rounded-xl text-gray-400 hover:text-gold hover:bg-gold/10 transition group" data-target="categories">
                    <i class="fa-solid fa-list text-lg md:text-base mb-1 md:mb-0"></i> <span class="text-[10px] md:text-sm font-medium">Categories</span>
                </button>
                <button onclick="navAdmin('banners')" class="admin-nav-btn flex-1 md:flex-none flex flex-col md:flex-row items-center md:space-x-3 justify-center md:justify-start px-2 py-2 md:px-4 md:py-3 rounded-xl text-gray-400 hover:text-gold hover:bg-gold/10 transition group" data-target="banners">
                    <i class="fa-solid fa-images text-lg md:text-base mb-1 md:mb-0"></i> <span class="text-[10px] md:text-sm font-medium">Banners</span>
                </button>
            </nav>
            <div class="hidden md:block p-4 border-t border-gray-800 space-y-3">
                <button onclick="openClientApp()" class="w-full flex items-center justify-center space-x-2 bg-white/5 hover:bg-white/10 text-gray-300 py-2.5 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-mobile-screen"></i> <span>Client View</span>
                </button>
                <button onclick="confirmLogout()" class="w-full flex items-center justify-center space-x-2 text-neonRed hover:text-red-400 hover:bg-neonRed/10 py-2.5 rounded-lg transition text-sm">
                    <i class="fa-solid fa-right-from-bracket"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-dark p-4 md:p-8 pb-20 md:pb-8 relative order-1 md:order-2">
            <div class="md:hidden flex justify-between items-center mb-6">
                 <h1 class="text-xl font-bold text-gold">ADMIN PANEL</h1>
                 <button onclick="openClientApp()" class="text-xs bg-white/10 px-3 py-1 rounded text-white">Exit</button>
            </div>

            <!-- Dashboard -->
            <div id="admin-dashboard" class="admin-subview w-full max-w-6xl mx-auto fade-in">
                <h2 class="text-3xl font-bold mb-8 text-white">Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-[#0a0a0a] p-6 rounded-2xl border border-gold/30 shadow-glow-gold relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-users text-6xl text-gold"></i></div>
                        <h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-2">Registered Users</h3>
                        <p id="stat-users" class="text-4xl font-black text-gold">0</p>
                    </div>
                    <div class="bg-[#0a0a0a] p-6 rounded-2xl border border-neonBlue/30 shadow-glow-blue relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-film text-6xl text-neonBlue"></i></div>
                        <h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-2">Movies</h3>
                        <p id="stat-movies" class="text-4xl font-black text-neonBlue">0</p>
                    </div>
                    <div class="bg-[#0a0a0a] p-6 rounded-2xl border border-neonGreen/30 relative overflow-hidden group shadow-[0_0_15px_rgba(0,255,65,0.2)]">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-list text-6xl text-neonGreen"></i></div>
                        <h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-2">Categories</h3>
                        <p id="stat-categories" class="text-4xl font-black text-neonGreen">0</p>
                    </div>
                    <div class="bg-[#0a0a0a] p-6 rounded-2xl border border-purple-500/30 relative overflow-hidden group shadow-[0_0_15px_rgba(168,85,247,0.2)]">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-images text-6xl text-purple-500"></i></div>
                        <h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-2">Banners</h3>
                        <p id="stat-banners" class="text-4xl font-black text-purple-500">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Movies Manager -->
            <div id="admin-movies" class="admin-subview hidden w-full max-w-6xl mx-auto fade-in">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">Movies</h2>
                    <button onclick="openMovieForm()" class="bg-neonBlue text-black hover:bg-cyan-400 px-5 py-2.5 rounded-xl shadow-glow-blue transition flex items-center text-sm font-bold">
                        <i class="fa-solid fa-plus mr-2"></i> Add Movie
                    </button>
                </div>
                <div class="bg-[#050505] rounded-2xl overflow-hidden border border-gray-800 shadow-2xl overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="bg-white/5 text-gray-400 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-5 font-semibold">Media</th>
                                <th class="p-5 font-semibold">Details</th>
                                <th class="p-5 font-semibold">Category</th>
                                <th class="p-5 text-right font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-movies-table" class="text-gray-300 text-sm divide-y divide-gray-800">
                             <!-- JS Injects Here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Categories -->
            <div id="admin-categories" class="admin-subview hidden w-full max-w-4xl mx-auto fade-in">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">Categories</h2>
                    <button onclick="openCategoryForm()" class="bg-neonGreen text-black hover:bg-green-400 px-5 py-2.5 rounded-xl shadow-[0_0_15px_rgba(0,255,65,0.4)] transition text-sm font-bold"><i class="fa-solid fa-plus mr-2"></i> Add New</button>
                </div>
                <div class="bg-[#050505] rounded-2xl overflow-hidden border border-gray-800 shadow-2xl"><table class="w-full text-left"><tbody id="admin-categories-table" class="text-gray-300 divide-y divide-gray-800"></tbody></table></div>
            </div>

            <!-- Banners -->
            <div id="admin-banners" class="admin-subview hidden w-full max-w-4xl mx-auto fade-in">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">Featured Banners</h2>
                    <button onclick="openBannerForm()" class="bg-purple-500 text-white hover:bg-purple-400 px-5 py-2.5 rounded-xl shadow-[0_0_15px_rgba(168,85,247,0.4)] transition text-sm font-bold"><i class="fa-solid fa-plus mr-2"></i> Add Banner</button>
                </div>
                <div class="bg-[#050505] rounded-2xl overflow-hidden border border-gray-800 shadow-2xl"><table class="w-full text-left"><tbody id="admin-banners-table" class="text-gray-300 divide-y divide-gray-800"></tbody></table></div>
            </div>
        </main>
    </div>

    <!-- GLOBAL OVERLAYS -->
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[200] flex flex-col items-center space-y-2 pointer-events-none w-full max-w-sm px-4"></div>
    <div id="confirm-modal" class="fixed inset-0 z-[210] hidden bg-black/80 backdrop-blur-md flex items-center justify-center p-4 fade-in">
        <div class="bg-[#0a0a0a] w-full max-w-sm rounded-3xl p-6 border border-red-500/30 shadow-glow-red transform transition-all scale-100">
            <div class="w-14 h-14 rounded-full bg-red-500/10 flex items-center justify-center mb-4 mx-auto">
                <i class="fa-solid fa-circle-question text-neonRed text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-center text-white mb-2">Confirmation</h3>
            <p id="confirm-text" class="text-gray-400 text-center text-sm mb-6">Are you sure you want to proceed?</p>
            <div class="flex space-x-3">
                <button onclick="closeConfirm()" class="flex-1 py-3 rounded-xl bg-gray-800 text-gray-300 hover:bg-gray-700 font-medium text-sm transition">Cancel</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 rounded-xl bg-neonRed text-white hover:bg-red-600 font-bold text-sm shadow-glow-red transition">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex items-center justify-center z-[220] p-4 transition-opacity">
        <div class="bg-[#0a0a0a] rounded-3xl w-full max-w-lg shadow-2xl border border-gray-800 max-h-[85vh] overflow-y-auto flex flex-col animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center shrink-0">
                <h3 id="admin-modal-title" class="text-xl font-bold text-white">Edit Item</h3>
                <button onclick="closeAdminModal()" class="text-gray-500 hover:text-white transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div id="admin-modal-content" class="p-6 space-y-5 overflow-y-auto custom-scrollbar"></div>
            <div class="p-6 border-t border-gray-800 flex justify-end space-x-3 bg-[#0a0a0a] shrink-0 rounded-b-3xl">
                <button onclick="closeAdminModal()" class="px-6 py-3 rounded-xl text-gray-400 hover:bg-white/5 transition text-sm font-medium">Cancel</button>
                <button id="admin-modal-save" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-xl text-white font-bold text-sm shadow-lg shadow-blue-600/20 transition">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[250] hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="loader mb-4"></div>
        <p id="loading-text" class="text-blue-400 font-medium text-sm animate-pulse tracking-wide">Processing...</p>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const IMGBB_API_KEY = "3c80047d27b3879c82842494f9b27b05"; 
        const firebaseConfig = {
            apiKey: "AIzaSyAEQEvCC779tQPLE5eAmPjt-sw7hQhkYCM",
            authDomain: "test-6371c.firebaseapp.com",
            databaseURL: "https://test-6371c-default-rtdb.firebaseio.com",
            projectId: "test-6371c",
            storageBucket: "test-6371c.firebasestorage.app",
            messagingSenderId: "824076706483",
            appId: "1:824076706483:web:97e65e21e073d4082f46c6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const ADMIN_EMAIL = "thepremanshu@gmail.com";
        const googleProvider = new GoogleAuthProvider();
        
        let moviesData = {}, categoriesData = {}, bannersData = {}, usersData = {};
        let currentUser = null;
        
        // SLIDER VARIABLES
        let bannerInterval = null;
        let sliderIndex = 1; 
        let isTransitioning = false;
        let totalSlides = 0;

        // === UTILS ===
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            let icon, border;
            if(type === 'success') { icon = '<i class="fa-solid fa-circle-check text-neonGreen"></i>'; border = 'border-neonGreen/30 shadow-glow-green'; }
            else if(type === 'warning') { icon = '<i class="fa-solid fa-eye text-gold"></i>'; border = 'border-gold/30 shadow-glow-gold'; }
            else { icon = '<i class="fa-solid fa-circle-exclamation text-neonRed"></i>'; border = 'border-neonRed/30 shadow-glow-red'; }
            el.className = `pointer-events-auto flex items-center space-x-3 bg-black/90 border ${border} text-white px-5 py-4 rounded-xl shadow-2xl backdrop-blur-md toast-enter z-[250]`;
            el.innerHTML = `${icon} <span class="text-sm font-bold tracking-wide">${msg}</span>`;
            container.appendChild(el);
            requestAnimationFrame(() => { el.classList.remove('toast-enter'); el.classList.add('toast-enter-active'); });
            setTimeout(() => { el.classList.remove('toast-enter-active'); el.classList.add('toast-exit-active'); setTimeout(() => el.remove(), 300); }, 3000);
        };

        window.showConfirm = (text, onYes) => {
            const m = document.getElementById('confirm-modal');
            document.getElementById('confirm-text').innerText = text;
            const btn = document.getElementById('confirm-yes-btn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => { onYes(); closeConfirm(); };
            m.classList.remove('hidden');
        };
        window.closeConfirm = () => document.getElementById('confirm-modal').classList.add('hidden');
        window.confirmLogout = () => showConfirm("Do you really want to sign out?", handleLogout);

        // === AUTH ===
        window.handleLogin = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            if(e && p) signInWithEmailAndPassword(auth, e, p).catch(err => showToast(err.message, 'error'));
        };
        
        window.handleSignUp = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            if(e && p) {
                createUserWithEmailAndPassword(auth, e, p)
                .then((userCredential) => {
                    const user = userCredential.user;
                    set(ref(db, 'users/' + user.uid), { email: user.email, createdAt: Date.now() });
                    showToast("Account Created!");
                }).catch(err => showToast(err.message, 'error'));
            }
        };

        window.handleGoogleLogin = () => {
            signInWithPopup(auth, googleProvider)
            .then((result) => {
                const user = result.user;
                set(ref(db, 'users/' + user.uid), { email: user.email, lastLogin: Date.now() });
                showToast("Welcome with Google!");
            }).catch(err => showToast(err.message, 'error'));
        };

        window.handleLogout = () => signOut(auth).then(() => { showToast('Signed out successfully'); navClient('home'); });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('header-login-mobile').classList.add('hidden');
                document.getElementById('header-login-desk').classList.add('hidden');
                document.getElementById('notif-wrapper-mobile').classList.remove('hidden');
                document.getElementById('notif-wrapper-desk').classList.remove('hidden');
                if(user.email === ADMIN_EMAIL) {
                    document.getElementById('nav-admin-btn-mobile').classList.remove('hidden');
                    document.getElementById('nav-admin-btn-desktop').classList.remove('hidden');
                } else {
                    document.getElementById('nav-admin-btn-mobile').classList.add('hidden');
                    document.getElementById('nav-admin-btn-desktop').classList.add('hidden');
                }
                renderProfileView();
            } else {
                document.getElementById('header-login-mobile').classList.remove('hidden');
                document.getElementById('header-login-desk').classList.remove('hidden');
                document.getElementById('notif-wrapper-mobile').classList.add('hidden');
                document.getElementById('notif-wrapper-desk').classList.add('hidden');
                document.getElementById('nav-admin-btn-mobile').classList.add('hidden');
                document.getElementById('nav-admin-btn-desktop').classList.add('hidden');
                renderProfileView();
            }
            loadData();
        });

        function renderProfileView() {
            const container = document.getElementById('view-profile');
            if(currentUser) {
                const photo = currentUser.photoURL || '';
                const displayImg = photo ? `<img src="${photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gradient-to-br from-neonBlue to-purple-600 flex items-center justify-center text-4xl font-bold text-black"><i class="fa-solid fa-user"></i></div>`;
                let adminBtnHtml = '';
                if(currentUser.email === ADMIN_EMAIL) {
                    adminBtnHtml = `<button onclick="openAdminPanel()" class="w-full bg-gold/10 border border-gold/50 hover:bg-gold/20 py-4 px-6 rounded-2xl flex justify-between items-center transition group"><span class="text-gold font-bold flex items-center"><i class="fa-solid fa-shield-halved mr-4 text-xl"></i> Admin Panel</span> <i class="fa-solid fa-arrow-right-to-bracket text-xs text-gold"></i></button>`;
                }
                container.innerHTML = `<div class="w-full max-w-2xl bg-white/5 p-8 rounded-3xl border border-white/5 mt-5"><div class="flex flex-col items-center"><div class="relative group cursor-pointer mb-5" onclick="document.getElementById('profile-pic-input').click()"><div class="w-32 h-32 rounded-full overflow-hidden border-4 border-neonBlue shadow-glow-blue bg-gray-900">${displayImg}</div><div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300"><i class="fa-solid fa-camera text-white text-xl"></i></div><input type="file" id="profile-pic-input" accept="image/*" class="hidden" onchange="handleProfilePicUpload(this)"></div><div class="flex items-center space-x-3 mb-1"><input id="profile-name-input" type="text" value="${currentUser.displayName || 'User'}" disabled class="bg-transparent text-2xl font-bold text-white text-center border-b border-transparent focus:border-neonBlue outline-none w-auto min-w-[100px] disabled:opacity-100 transition"><button onclick="toggleNameEdit()" class="text-gray-500 hover:text-neonBlue"><i id="name-edit-icon" class="fa-solid fa-pen"></i></button></div><p class="text-gray-400 text-sm mb-10 bg-white/5 px-4 py-1.5 rounded-full border border-white/5">${currentUser.email}</p></div><div class="w-full space-y-4"><button onclick="openHistory()" class="w-full bg-gray-800/40 hover:bg-gray-800/80 py-5 px-6 rounded-2xl flex justify-between items-center transition border border-white/5 group hover:border-neonBlue/50"><span class="font-medium text-gray-300 group-hover:text-white flex items-center"><i class="fa-solid fa-clock-rotate-left text-neonBlue mr-4 text-xl"></i> Watch History</span> <i class="fa-solid fa-chevron-right text-xs text-gray-600"></i></button>${adminBtnHtml}<button onclick="confirmLogout()" class="w-full bg-neonRed/10 text-neonRed border border-neonRed/20 hover:bg-neonRed/20 py-5 px-6 rounded-2xl font-bold mt-8 transition flex items-center justify-center hover:shadow-glow-red"><i class="fa-solid fa-power-off mr-3"></i> Sign Out</button></div></div>`;
            } else {
                container.innerHTML = `<div class="w-full max-w-md bg-black/50 p-10 rounded-3xl border border-white/10 shadow-2xl backdrop-blur-xl mt-10"><div class="flex flex-col items-center mb-8"><h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-neonBlue to-purple-500 tracking-tighter">CINEFY</h1><p class="text-gray-400 mt-2 text-sm tracking-widest uppercase font-semibold">Login to Stream</p></div><div class="space-y-5"><div class="relative group"><i class="fa-solid fa-envelope absolute left-4 top-4 text-gray-500 group-focus-within:text-neonBlue transition"></i><input type="email" id="auth-email" placeholder="Email Address" class="input-glow w-full bg-black/60 border border-white/10 pl-12 pr-4 py-4 rounded-xl text-white focus:outline-none transition placeholder-gray-600 text-sm"></div><div class="relative group"><i class="fa-solid fa-lock absolute left-4 top-4 text-gray-500 group-focus-within:text-neonBlue transition"></i><input type="password" id="auth-pass" placeholder="Password" class="input-glow w-full bg-black/60 border border-white/10 pl-12 pr-4 py-4 rounded-xl text-white focus:outline-none transition placeholder-gray-600 text-sm"></div></div><button onclick="handleLogin()" class="w-full bg-gradient-to-r from-neonBlue to-blue-600 hover:from-blue-400 hover:to-blue-500 text-black py-4 rounded-xl font-bold mt-8 transition shadow-glow-blue active:scale-[0.98]">Sign In</button><button onclick="handleSignUp()" class="w-full bg-white/5 hover:bg-white/10 text-gray-300 py-4 rounded-xl font-semibold mt-3 transition border border-white/5 text-sm">Create Account</button><div class="relative flex py-6 items-center"><div class="flex-grow border-t border-gray-800"></div><span class="flex-shrink-0 mx-4 text-gray-600 text-xs font-bold tracking-wider">OR CONTINUE WITH</span><div class="flex-grow border-t border-gray-800"></div></div><button onclick="handleGoogleLogin()" class="w-full bg-white text-gray-900 py-3.5 rounded-xl font-bold transition flex items-center justify-center space-x-3 active:scale-[0.98] hover:bg-gray-100"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"><span>Google</span></button></div>`;
            }
        }

        window.openMovieModal = (m) => {
            const watchBtn = document.getElementById('modal-watch-btn');
            
            // Extract Youtube ID function
            const getYoutubeId = (url) => {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            };

            const startWatching = () => {
                recordHistory(m.id);
                const ytId = getYoutubeId(m.watchUrl);
                if(ytId) {
                    // Open In-App Player
                    playVideo(`https://www.youtube.com/embed/${ytId}?autoplay=1&rel=0&modestbranding=1`);
                } else {
                    // Fallback for non-youtube links
                     playVideo(m.watchUrl);
                }
            };

            watchBtn.onclick = () => {
                if(currentUser) {
                    startWatching();
                } else {
                    let guestCount = parseInt(localStorage.getItem('cinefy_guest_count') || '0');
                    if(guestCount < 2) {
                        guestCount++;
                        localStorage.setItem('cinefy_guest_count', guestCount);
                        showToast(`Guest Mode: Watching ${guestCount}/2 movies`, 'warning');
                        startWatching();
                    } else {
                        showToast("Limit Reached! Login to continue.", 'error');
                        closeModal();
                        navClient('profile');
                    }
                }
            };
            document.getElementById('modal-poster').src = m.posterUrl; 
            document.getElementById('modal-title').innerText = m.title; 
            document.getElementById('modal-year').innerText = m.year;
            document.getElementById('modal-rating').querySelector('span').innerText = m.rating; 
            document.getElementById('modal-desc').innerText = m.description || "No synopsis available."; 
            document.getElementById('modal-cast').innerText = m.cast || "N/A";
            
            if(m.watchUrl) { watchBtn.classList.remove('hidden'); } 
            else { watchBtn.classList.add('hidden'); }
            document.getElementById('movie-modal').classList.remove('hidden');
        };
        
        // Video Player Functions
        window.playVideo = (url) => {
             const overlay = document.getElementById('video-player-overlay');
             const container = document.getElementById('player-container');
             container.innerHTML = `<iframe src="${url}" class="w-full h-full border-0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
             overlay.classList.remove('hidden');
        };
        
        window.closeVideo = () => {
            document.getElementById('video-player-overlay').classList.add('hidden');
            document.getElementById('player-container').innerHTML = ''; // Stop video
        };

        window.toggleNameEdit = async () => { const input = document.getElementById('profile-name-input'); const icon = document.getElementById('name-edit-icon'); if(input.disabled) { input.disabled = false; input.focus(); icon.className = "fa-solid fa-check text-neonGreen"; } else { input.disabled = true; icon.className = "fa-solid fa-pen"; if(input.value !== currentUser.displayName) { try { await updateProfile(currentUser, { displayName: input.value }); showToast("Name updated"); } catch(e) { showToast(e.message, 'error'); } } } };
        window.handleProfilePicUpload = async (input) => { if (input.files && input.files[0]) { const url = await uploadToImgBB(input.files[0]); if(url) { try { await updateProfile(currentUser, { photoURL: url }); renderProfileView(); showToast("Profile picture updated"); } catch(e) { showToast(e.message, 'error'); } } } };
        window.navClient = (target) => { document.querySelectorAll('.client-subview').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${target}`).classList.remove('hidden'); if(target === 'categories') backToCategories(); document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.toggle('text-neonBlue', btn.dataset.target === target); btn.classList.toggle('text-gray-500', btn.dataset.target !== target); }); document.querySelectorAll('.nav-sidebar-btn').forEach(btn => { const isActive = btn.dataset.target === target; if(isActive) { btn.classList.add('bg-white/10', 'text-white', 'border-white/10'); btn.classList.remove('text-gray-400', 'border-transparent'); btn.querySelector('i').classList.add('text-neonBlue'); } else { btn.classList.remove('bg-white/10', 'text-white', 'border-white/10'); btn.classList.add('text-gray-400', 'border-transparent'); btn.querySelector('i').classList.remove('text-neonBlue'); } }); };

        function loadData() {
            onValue(ref(db, 'categories'), s => { categoriesData = s.val() || {}; renderAll(); });
            onValue(ref(db, 'movies'), s => { const raw = s.val() || {}; moviesData = {}; Object.keys(raw).forEach(key => moviesData[key] = { ...raw[key], id: key }); renderAll(); checkNotifications(); });
            onValue(ref(db, 'banners'), s => { bannersData = s.val() || {}; renderAll(); });
            onValue(ref(db, 'users'), s => { usersData = s.val() || {}; renderAdminStats(); });
        }
        function renderAll() { renderClientHome(); renderClientCategories(); renderAdminStats(); renderAdminLists(); }
        function renderAdminStats() { document.getElementById('stat-movies').innerText = Object.keys(moviesData).length; document.getElementById('stat-categories').innerText = Object.keys(categoriesData).length; document.getElementById('stat-banners').innerText = Object.keys(bannersData).length; document.getElementById('stat-users').innerText = Object.keys(usersData).length; }

        function renderAdminLists() {
            const mt = document.getElementById('admin-movies-table');
            if(mt) {
                let html = '';
                const mArr = Object.entries(moviesData);
                if(mArr.length === 0) html = '<tr><td colspan="4" class="p-5 text-center text-gray-500">No movies found.</td></tr>';
                else {
                    mArr.forEach(([id, m]) => {
                        html += `<tr class="border-b border-gray-800 hover:bg-white/5 transition"><td class="p-5"><img src="${m.posterUrl}" class="w-10 h-14 object-cover rounded shadow-md bg-gray-800"></td><td class="p-5"><p class="font-bold text-gray-200 truncate max-w-[150px]">${m.title}</p><p class="text-xs text-gray-500">${m.year}</p></td><td class="p-5"><span class="bg-white/5 px-3 py-1 rounded text-xs text-gray-400 border border-white/10">${categoriesData[m.categoryId]?.name||'-'}</span></td><td class="p-5 text-right space-x-2"><button onclick="openMovieForm('${id}')" class="text-neonBlue hover:bg-neonBlue/10 p-2 rounded transition"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="del('movies', '${id}')" class="text-neonRed hover:bg-neonRed/10 p-2 rounded transition"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    });
                }
                mt.innerHTML = html;
            }

            const ct = document.getElementById('admin-categories-table');
            if(ct) {
                let html = '';
                const cArr = Object.entries(categoriesData);
                if(cArr.length === 0) html = '<tr><td colspan="2" class="p-5 text-center text-gray-500">No categories found.</td></tr>';
                else {
                    cArr.forEach(([id, c]) => {
                        html += `<tr class="border-b border-gray-800"><td class="p-5 font-semibold text-gray-200">${c.name}</td><td class="p-5 text-right"><button onclick="del('categories', '${id}')" class="text-neonRed p-2"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    });
                }
                ct.innerHTML = html;
            }

            const bt = document.getElementById('admin-banners-table');
            if(bt) {
                let html = '';
                const bArr = Object.entries(bannersData);
                if(bArr.length === 0) html = '<tr><td colspan="2" class="p-5 text-center text-gray-500">No banners found.</td></tr>';
                else {
                    bArr.forEach(([id, b]) => {
                        html += `<tr class="border-b border-gray-800"><td class="p-5"><img src="${b.imageUrl}" class="w-24 h-12 object-cover rounded shadow-sm"></td><td class="p-5 text-right"><button onclick="del('banners', '${id}')" class="text-neonRed p-2"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    });
                }
                bt.innerHTML = html;
            }
        }

        // ================= FIX: SLIDER & MOBILE ASPECT RATIO =================
        function renderClientHome() {
            const track = document.getElementById('banner-track'); 
            const indicators = document.getElementById('slider-indicators'); 
            const container = track.parentElement.parentElement; // Get the main wrapper

            // FIX: Use aspect-video for mobile to show full banner
            container.className = "relative w-full aspect-video md:aspect-auto md:h-[75vh] bg-gray-900 group";

            const bans = Object.values(bannersData);
            
            if(bans.length > 0) {
                track.innerHTML = ''; 
                indicators.innerHTML = ''; 
                
                // Add Last Clone (for infinite loop to left)
                const lastClone = document.createElement('div'); 
                lastClone.className = 'slide'; 
                lastClone.id = 'last-clone'; 
                lastClone.innerHTML = `<img src="${bans[bans.length - 1].imageUrl}">`; 
                track.appendChild(lastClone);

                // Add Real Slides
                bans.forEach((b, index) => { 
                    const slide = document.createElement('div'); 
                    slide.className = 'slide'; 
                    slide.innerHTML = `<img src="${b.imageUrl}">`; 
                    track.appendChild(slide); 
                    
                    const dot = document.createElement('div'); 
                    dot.className = 'w-2 h-2 rounded-full transition-all duration-300 cursor-pointer bg-white/50'; 
                    dot.onclick = () => jumpToSlide(index + 1); 
                    indicators.appendChild(dot); 
                });

                // Add First Clone (for infinite loop to right)
                const firstClone = document.createElement('div'); 
                firstClone.className = 'slide'; 
                firstClone.id = 'first-clone'; 
                firstClone.innerHTML = `<img src="${bans[0].imageUrl}">`; 
                track.appendChild(firstClone); 

                initSlider(bans.length);
            } else { 
                track.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-600">No Banners</div>'; 
            }
            renderMoviesList();
        }

        function initSlider(count) {
            const track = document.getElementById('banner-track');
            totalSlides = count;
            sliderIndex = 1; 
            isTransitioning = false;
            
            // Set Initial Position
            track.style.transition = 'none'; 
            track.style.transform = `translateX(-100%)`; 
            updateIndicatorsVisual(0);

            // Handle Transition End (The loop logic)
            track.ontransitionend = () => {
                isTransitioning = false;
                if (sliderIndex > totalSlides) {
                    track.style.transition = 'none';
                    sliderIndex = 1;
                    track.style.transform = `translateX(-100%)`;
                }
                if (sliderIndex === 0) {
                    track.style.transition = 'none';
                    sliderIndex = totalSlides;
                    track.style.transform = `translateX(-${totalSlides * 100}%)`;
                }
            };

            // Touch / Swipe Logic
            let startX = 0;
            let endX = 0;
            const container = document.querySelector('.slider-container');

            // Remove old listeners to prevent stacking
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            newContainer.appendChild(track); // Re-append track because cloning clears it? No, cloning copies children.
            // Actually cloning copies children, so track is inside newContainer. We need to re-ref track.
            const newTrack = document.getElementById('banner-track');

            newContainer.addEventListener('touchstart', (e) => {
                clearInterval(bannerInterval);
                startX = e.changedTouches[0].screenX;
            }, {passive: true});

            newContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].screenX;
                if (startX - endX > 50) {
                     // Swipe Left (Next)
                     moveSlide(1, totalSlides);
                } else if (endX - startX > 50) {
                    // Swipe Right (Prev)
                    moveSlide(-1, totalSlides);
                }
                startAutoPlay();
            }, {passive: true});
            
            // Re-bind transition end to new track
            newTrack.ontransitionend = track.ontransitionend;

            startAutoPlay();
        }

        function startAutoPlay() { 
            if(bannerInterval) clearInterval(bannerInterval); 
            bannerInterval = setInterval(() => moveSlide(1, totalSlides), 5000); 
        }

        window.moveSlide = (dir, count) => {
            const track = document.getElementById('banner-track');
            if (isTransitioning) return;
            
            sliderIndex += dir;
            isTransitioning = true;
            
            track.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
            track.style.transform = `translateX(-${sliderIndex * 100}%)`;

            // Visual indicator logic
            let visualIndex = sliderIndex - 1;
            if(visualIndex >= count) visualIndex = 0;
            if(visualIndex < 0) visualIndex = count - 1;
            updateIndicatorsVisual(visualIndex);
            
            // Reset Interval on click
            startAutoPlay();
        }

        window.jumpToSlide = (index) => {
            if (isTransitioning) return;
            const track = document.getElementById('banner-track');
            sliderIndex = index;
            track.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
            track.style.transform = `translateX(-${sliderIndex * 100}%)`;
            updateIndicatorsVisual(index - 1);
            startAutoPlay();
        }

        function updateIndicatorsVisual(activeIdx) {
            const container = document.getElementById('slider-indicators');
            if(!container) return;
            const dots = container.children;
            for(let i=0; i<dots.length; i++) {
                dots[i].className = `w-2 h-2 rounded-full transition-all duration-300 cursor-pointer ${i === activeIdx ? 'bg-neonBlue w-6 shadow-glow-blue' : 'bg-white/50'}`;
            }
        }
        // ================= END SLIDER FIX =================

        // === CATEGORY STYLING HELPER ===
        function getCategoryTheme(name) {
            const n = name.toLowerCase();
            if(n.includes('action') || n.includes('adventure')) return { color: 'from-orange-600 to-red-600', icon: 'fa-fire-flame-curved', glow: 'shadow-glow-red', text: 'text-red-500' };
            if(n.includes('sci') || n.includes('space')) return { color: 'from-blue-600 to-cyan-400', icon: 'fa-rocket', glow: 'shadow-glow-blue', text: 'text-cyan-400' };
            if(n.includes('horror') || n.includes('thriller')) return { color: 'from-purple-900 to-gray-900', icon: 'fa-ghost', glow: 'shadow-[0_0_15px_rgba(168,85,247,0.4)]', text: 'text-purple-500' };
            if(n.includes('comedy') || n.includes('fun')) return { color: 'from-yellow-400 to-orange-400', icon: 'fa-masks-theater', glow: 'shadow-glow-gold', text: 'text-gold' };
            if(n.includes('romance') || n.includes('love')) return { color: 'from-pink-500 to-rose-500', icon: 'fa-heart', glow: 'shadow-[0_0_15px_rgba(244,63,94,0.4)]', text: 'text-pink-500' };
            if(n.includes('drama')) return { color: 'from-emerald-600 to-teal-500', icon: 'fa-film', glow: 'shadow-glow-green', text: 'text-emerald-400' };
            if(n.includes('animation') || n.includes('kids')) return { color: 'from-indigo-500 to-purple-500', icon: 'fa-wand-magic-sparkles', glow: 'shadow-glow-blue', text: 'text-indigo-400' };
            return { color: 'from-gray-700 to-gray-900', icon: 'fa-clapperboard', glow: 'shadow-none', text: 'text-gray-400' };
        }

        function renderClientCategories() {
            const grid = document.getElementById('categories-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            Object.entries(categoriesData).forEach(([id, cat]) => {
                const theme = getCategoryTheme(cat.name);
                const el = document.createElement('div');
                
                // Updated Card Design: 3D Tilt Effect + Glassmorphism + Dynamic Gradient
                el.className = "cat-card relative h-36 md:h-44 rounded-3xl overflow-hidden cursor-pointer group transition-all duration-300 hover:-translate-y-2 border border-white/5 hover:border-white/20 hover:shadow-2xl " + theme.glow;
                el.onclick = () => openCategoryView(id);
                el.innerHTML = `
                    <div class="cat-bg absolute inset-0 bg-gradient-to-br ${theme.color} opacity-40 group-hover:opacity-70 transition duration-500"></div>
                    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm group-hover:backdrop-blur-none transition duration-500"></div>
                    
                    <!-- Decor Icon -->
                    <i class="cat-icon fa-solid ${theme.icon} absolute -bottom-4 -right-4 text-[7rem] md:text-[9rem] text-white/5 group-hover:text-white/20 transition-all duration-500 ease-out origin-bottom-right transform rotate-0"></i>
                    
                    <!-- Content -->
                    <div class="absolute inset-0 p-6 flex flex-col justify-end z-10">
                        <div class="transform translate-y-2 group-hover:translate-y-0 transition duration-300">
                             <span class="text-xs font-bold text-white/50 uppercase tracking-widest mb-1 block opacity-0 group-hover:opacity-100 transition delay-75">Genre</span>
                             <h3 class="text-2xl md:text-3xl font-black text-white tracking-tighter uppercase drop-shadow-md group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-gray-300">${cat.name}</h3>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        window.openCategoryView = (catId) => {
            const cat = categoriesData[catId];
            if(!cat) return;
            document.getElementById('categories-main-list').classList.add('hidden');
            document.getElementById('category-movies-view').classList.remove('hidden');
            document.getElementById('selected-category-title').innerText = cat.name;

            const results = document.getElementById('selected-category-results');
            results.innerHTML = '';
            const movies = Object.values(moviesData).filter(m => m.categoryId === catId);
            
            if(movies.length === 0) {
                results.innerHTML = '<p class="text-gray-500 col-span-full text-center mt-10">No movies in this genre yet.</p>';
                return;
            }
            
            movies.forEach(m => {
                const el = createMovieCard(m);
                results.appendChild(el);
            });
        };

        window.backToCategories = () => {
            document.getElementById('category-movies-view').classList.add('hidden');
            document.getElementById('categories-main-list').classList.remove('hidden');
        };

        window.performSearch = () => {
            const query = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if(!query) return;

            const results = Object.values(moviesData).filter(m => m.title.toLowerCase().includes(query));
            
            if(results.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center mt-10">No matches found.</p>';
                return;
            }

            results.forEach(m => {
                const el = createMovieCard(m);
                container.appendChild(el);
            });
        };

        function createMovieCard(m) {
            const d = document.createElement('div'); 
            d.className = "group cursor-pointer flex flex-col"; 
            d.onclick = () => openMovieModal(m);
            // Smaller size for grid/search items as well
            d.innerHTML = `
                <div class="relative overflow-hidden rounded-2xl shadow-lg mb-3 aspect-[2/3] border border-transparent group-hover:border-neonBlue/50 transition duration-300">
                    <img src="${m.posterUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 bg-gray-900">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition duration-300"></div>
                    <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold text-gold border border-gold/30 shadow-glow-gold">
                        <i class="fa-solid fa-star mr-1"></i>${m.rating}
                    </div>
                </div>
                <h4 class="text-gray-100 font-bold text-sm truncate group-hover:text-neonBlue transition">${m.title}</h4>
                <div class="flex justify-between mt-1 text-[11px] text-gray-500 font-medium"><span>${m.year}</span></div>
            `;
            return d;
        }

        function renderMoviesList() {
            const mc = document.getElementById('movies-container'); mc.innerHTML = '';
            Object.entries(categoriesData).forEach(([cid, cat]) => {
                const ms = Object.values(moviesData).filter(m => m.categoryId === cid);
                if(ms.length > 0) {
                    const sec = document.createElement('div'); sec.className = "pl-5 md:pl-10";
                    sec.innerHTML = `<h3 class="text-lg font-bold text-gray-100 mb-4 tracking-wide flex items-center text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400"><div class="w-1 h-6 bg-neonBlue mr-3 rounded-full shadow-glow-blue"></div>${cat.name}</h3>`;
                    const row = document.createElement('div'); row.className = "flex space-x-4 overflow-x-auto no-scrollbar pb-6 pr-5";
                    ms.forEach(m => {
                        const d = document.createElement('div'); 
                        d.className = "flex-shrink-0 w-28 md:w-36 group cursor-pointer"; 
                        d.onclick = () => openMovieModal(m);
                        d.innerHTML = `
                            <div class="relative overflow-hidden rounded-2xl shadow-lg mb-3 aspect-[2/3] border border-transparent group-hover:border-neonBlue/50 transition duration-300">
                                <img src="${m.posterUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 bg-gray-900">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition duration-300"></div>
                                <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold text-gold border border-gold/30 shadow-glow-gold">
                                    <i class="fa-solid fa-star mr-1"></i>${m.rating}
                                </div>
                            </div>
                            <h4 class="text-gray-100 font-bold text-xs md:text-sm truncate group-hover:text-neonBlue transition">${m.title}</h4>
                            <div class="flex justify-between mt-1 text-[10px] text-gray-500 font-medium"><span>${m.year}</span></div>
                        `;
                        row.appendChild(d);
                    }); sec.appendChild(row); mc.appendChild(sec);
                }
            });
        }
        
        window.navAdmin = (target) => { document.querySelectorAll('.admin-subview').forEach(el => el.classList.add('hidden')); document.getElementById(`admin-${target}`).classList.remove('hidden'); document.querySelectorAll('.admin-nav-btn').forEach(btn => { const isActive = btn.dataset.target === target; if(isActive) { btn.classList.add('text-gold'); btn.classList.remove('text-gray-400'); } else { btn.classList.remove('text-gold'); btn.classList.add('text-gray-400'); } }); };
        window.openAdminPanel = () => { document.getElementById('client-view').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden'); navAdmin('dashboard'); };
        window.openClientApp = () => { document.getElementById('admin-view').classList.add('hidden'); document.getElementById('client-view').classList.remove('hidden'); navClient('home'); };
        window.closeModal = () => document.getElementById('movie-modal').classList.add('hidden');
        
        async function compressImage(file, maxWidth = 800) { return new Promise((resolve, reject) => { const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } else { if (h > maxWidth) { w *= maxWidth / h; h = maxWidth; } } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.8); }; img.onerror = e => reject(e); }); }
        async function uploadToImgBB(file) { document.getElementById('loading-overlay').classList.remove('hidden'); try { const compressed = await compressImage(file); const fd = new FormData(); fd.append("image", compressed); const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: fd }); const data = await res.json(); document.getElementById('loading-overlay').classList.add('hidden'); if(data.success) return data.data.url; else throw new Error("Upload Failed"); } catch(e) { document.getElementById('loading-overlay').classList.add('hidden'); showToast(e.message, 'error'); return null; } }
        window.del = (path, id) => showConfirm("Delete permanently?", () => remove(ref(db, `${path}/${id}`)).then(()=>showToast("Deleted")));
        window.openMovieForm = (id=null) => { const m = id ? moviesData[id] : {title:'', year:'', rating:'', description:'', cast:'', watchUrl:'', categoryId:''}; let opts = '<option value="">Select Category</option>'; Object.entries(categoriesData).forEach(([k,v]) => opts += `<option value="${k}" ${m.categoryId===k?'selected':''}>${v.name}</option>`); const html = `<div class="space-y-4"><input id="f-title" placeholder="Movie Title" value="${m.title}" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none"><div class="grid grid-cols-2 gap-4"><input id="f-year" type="number" placeholder="Year" value="${m.year}" class="input-glow bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none"><input id="f-rating" type="number" step="0.1" placeholder="Rating" value="${m.rating}" class="input-glow bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none"></div><select id="f-cat" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none">${opts}</select><div class="bg-white/5 p-4 rounded-xl border border-dashed border-white/10"><p class="text-xs text-gray-500 mb-2">Poster Image</p><input id="f-file" type="file" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white">${m.posterUrl ? `<img src="${m.posterUrl}" class="h-24 mt-3 rounded shadow-md">` : ''}</div><input id="f-watch" placeholder="Stream Link" value="${m.watchUrl}" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none"><textarea id="f-desc" placeholder="Synopsis" rows="3" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none">${m.description}</textarea><input id="f-cast" placeholder="Cast" value="${m.cast}" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white focus:outline-none"></div>`; openAdminModal(id?'Edit Movie':'Add New Movie', html, async () => { const file = document.getElementById('f-file').files[0]; let posterUrl = m.posterUrl; if(file) { posterUrl = await uploadToImgBB(file); if(!posterUrl) return; } if(!posterUrl && !id) return showToast("Poster required", 'error'); const data = { title: document.getElementById('f-title').value, year: document.getElementById('f-year').value, rating: document.getElementById('f-rating').value, categoryId: document.getElementById('f-cat').value, watchUrl: document.getElementById('f-watch').value, description: document.getElementById('f-desc').value, cast: document.getElementById('f-cast').value, posterUrl, createdAt: m.createdAt || Date.now() }; if(id) await update(ref(db, `movies/${id}`), data); else await push(ref(db, 'movies'), data); showToast("Movie saved"); }); };
        window.openCategoryForm = () => openAdminModal('New Category', `<input id="f-cname" placeholder="Category Name" class="input-glow w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white outline-none">`, async()=>{ if(document.getElementById('f-cname').value) await push(ref(db, 'categories'), {name: document.getElementById('f-cname').value}); });
        window.openBannerForm = () => openAdminModal('New Banner', `<input id="f-bfile" type="file" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white">`, async()=>{ const f = document.getElementById('f-bfile').files[0]; if(f) { const u = await uploadToImgBB(f); if(u) await push(ref(db, 'banners'), {imageUrl:u}); } });
        function openAdminModal(title, content, onSave) { document.getElementById('admin-modal-title').innerText = title; document.getElementById('admin-modal-content').innerHTML = content; const btn = document.getElementById('admin-modal-save'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.onclick = async () => { newBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`; try { await onSave(); closeAdminModal(); } catch(e) { showToast(e.message, 'error'); } finally { newBtn.innerText = "Save Changes"; } }; document.getElementById('admin-modal').classList.remove('hidden'); }
        window.closeAdminModal = () => document.getElementById('admin-modal').classList.add('hidden');
        
        window.toggleNotifications = () => { const m = document.getElementById('notif-dropdown'); const d = document.getElementById('notif-dropdown-desk'); if(m.classList.contains('hidden') && d.classList.contains('hidden')) { m.classList.remove('hidden'); d.classList.remove('hidden'); document.getElementById('notif-badge').classList.add('hidden'); document.getElementById('notif-badge-desk').classList.add('hidden'); localStorage.setItem('lastNotifCheck', Date.now()); } else { m.classList.add('hidden'); d.classList.add('hidden'); } };
        function checkNotifications() { const lastCheck = localStorage.getItem('lastNotifCheck') || 0; const newMovies = Object.values(moviesData).filter(m => m.createdAt && m.createdAt > lastCheck); const bM = document.getElementById('notif-badge'); const bD = document.getElementById('notif-badge-desk'); const lM = document.getElementById('notif-list'); const lD = document.getElementById('notif-list-desk'); if(newMovies.length > 0) { bM.classList.remove('hidden'); bD.classList.remove('hidden'); const html = newMovies.sort((a,b) => b.createdAt - a.createdAt).map(m => `<div class="flex items-center space-x-3 p-2 hover:bg-white/5 rounded-lg cursor-pointer transition group" onclick="openMovieModal(moviesData['${m.id}']); toggleNotifications();"><img src="${m.posterUrl}" class="w-10 h-14 object-cover rounded bg-gray-700"><div class="flex-1 min-w-0"><h4 class="text-xs font-bold text-white truncate group-hover:text-neonBlue transition">${m.title}</h4></div><div class="w-2 h-2 rounded-full bg-neonBlue"></div></div>`).join(''); lM.innerHTML = html; lD.innerHTML = html; } else { lM.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">No new notifications</p>'; lD.innerHTML = lM.innerHTML; } }
        
        // History Logic (Standard)
        window.openHistory = () => { navClient('profile'); document.getElementById('view-profile').classList.add('hidden'); document.getElementById('view-history').classList.remove('hidden'); renderHistory(); };
        function renderHistory() { if(!currentUser) return; const container = document.getElementById('history-list'); container.innerHTML = '<div class="loader mx-auto mt-10"></div>'; onValue(ref(db, `users/${currentUser.uid}/history`), (snapshot) => { const history = snapshot.val() || {}; container.innerHTML = ''; const tenDaysAgo = Date.now() - (10 * 24 * 60 * 60 * 1000); const items = Object.entries(history).map(([key, val]) => ({...val, key})).filter(item => item.timestamp > tenDaysAgo).sort((a, b) => b.timestamp - a.timestamp); if(items.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center pt-20 text-gray-500"><i class="fa-solid fa-clock-rotate-left text-4xl mb-4 opacity-30"></i><p class="text-sm font-medium">No watch history available.</p></div>`; return; } items.forEach(item => { const el = document.createElement('div'); el.className = "flex items-center space-x-4 bg-white/5 hover:bg-white/10 p-3 rounded-xl border border-white/5 transition group"; el.innerHTML = `<img src="${item.posterUrl}" class="w-12 h-16 object-cover rounded-lg bg-gray-800 shadow-lg"><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-200 text-sm truncate group-hover:text-white">${item.title}</h4><p class="text-[10px] text-gray-500 mt-1">Watched: ${new Date(item.timestamp).toLocaleDateString()}</p></div><button onclick="deleteHistoryItem('${item.key}')" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:text-red-400 hover:bg-red-500/10 transition"><i class="fa-solid fa-trash text-xs"></i></button>`; container.appendChild(el); }); }, { onlyOnce: true }); }
        window.deleteHistoryItem = (key) => showConfirm("Remove from history?", () => remove(ref(db, `users/${currentUser.uid}/history/${key}`)).then(() => { showToast("Removed"); renderHistory(); }));
        window.clearAllHistory = () => showConfirm("Clear history?", () => remove(ref(db, `users/${currentUser.uid}/history`)).then(() => { showToast("Cleared"); renderHistory(); }));
        window.recordHistory = (movieId) => { if(!currentUser || !moviesData[movieId]) return; const m = moviesData[movieId]; push(ref(db, `users/${currentUser.uid}/history`), { movieId, title: m.title, posterUrl: m.posterUrl, timestamp: Date.now() }); };

    </script>
</body>
</html>